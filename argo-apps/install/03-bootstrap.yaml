# =============================================================================
# ArgoCD Bootstrap - Projects and Root App
# =============================================================================
#
# Bootstraps the GitOps system by creating:
#   1. AppProject (prod-apps) - Single unified project
#   2. Root App-of-Apps - Manages all child applications
#
# Deployment Order:
#   1. 01-namespaces.yaml
#   2. 02-argocd-install.yaml (wait for ArgoCD to be ready)
#   3. THIS FILE - Creates project and root app
#
# The root app will then deploy:
#   - web-app
#   - prometheus
#   - grafana
#   - vault
#
# Compatibility: ArgoCD 2.13+, Kubernetes 1.33+
# =============================================================================

# ===================================
# 1. AppProject Bootstrap Application
# ===================================
# This app manages the AppProject via GitOps
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd-projects
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-projects
    app.kubernetes.io/part-of: gitops-bootstrap
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "Manages ArgoCD AppProjects via GitOps"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  
  source:
    repoURL: https://github.com/humzamalak/Production-Ready-EKS-Cluster-with-GitOps
    targetRevision: main
    path: argocd/projects
    directory:
      recurse: false
  
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  revisionHistoryLimit: 3

---
# ===================================
# 2. Root App-of-Apps
# ===================================
# Manages all child applications
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: root-app
  namespace: argocd
  labels:
    app.kubernetes.io/name: root-app
    app.kubernetes.io/part-of: gitops
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    description: "Root App-of-Apps managing all production applications"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: prod-apps
  
  source:
    repoURL: https://github.com/humzamalak/Production-Ready-EKS-Cluster-with-GitOps
    targetRevision: main
    path: argocd/apps
    directory:
      recurse: false
      # Only sync Application resources
      include: '*.yaml'
  
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  revisionHistoryLimit: 3



